---
title: "VIH y el ambiente"
author: "Rocío Águeda"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 6
    toc_float: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introducción

El VIH (virus de la inmunodeficiencia humana) es un virus que ataca el sistema inmunitario del cuerpo, setransmite a través de la sangre y actualmente no tiene cura, únicamente se puede controlar con una adecuada atención médica.


### Objetivos

- Investigar si existe relación entre la causa de contagio y el año.
- Conocer si el tamaño de la población afecta a la propagación del virus.

## Métodos
### Carga de paquetes

Para llevar a cabo la investigación se ha hecho uso de algunos paquetes necesarios para leer, modificar, unir y plasmar los datos de forma visual a modo de tablas y gráficos.

```{r, warning = FALSE, message = FALSE}
library(readr)
library(dplyr)
library(ggplot2)
library(tidyverse)
```

### Carga de datos

Los datos que he utilizado estaban contenidos en 3 tablas, dos de ellas "Registro_regional_de_sida" y "Registro_nuevas_infecciones_por_vih" provienen de la sección de datos abiertos página de la [Junta de Castilla y León](https://datosabiertos.jcyl.es/web/es/datos-abiertos-castilla-leon.html). La tabla "poblacionCyL" pertenece a la página web de datos abiertos del gobierno de España, a la que podéis acceder desde [aquí](https://datos.gob.es/es/catalogo).
Todos ellos han sido descargados en formato CSV.

```{r, warning = FALSE, message = FALSE}
registro_regional_de_sida <- read_delim("INPUT/DATA/registro-regional-de-sida.csv", col_types = cols(
                                        "Año de diagnóstico" = readr::col_integer(),
                                        "Edad años" = readr::col_integer()),
                                        delim = ";", escape_double = FALSE, trim_ws = TRUE)

registro_nuevas_infecciones_por_vih <- read_delim("INPUT/DATA/registro-nuevas-infecciones-por-vih.csv",col_types = cols(
                                        Año = readr::col_integer(),
                                        "VIH" = readr::col_integer()),
                                                  delim = ";", escape_double = FALSE, trim_ws = TRUE)

poblacionCyL <- read_delim("INPUT/DATA/04001.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)

```

### Exploración de los datos
Una vez cargadas, pasamos a cambiar los nombres que venían en las columnas por otros más correctos semánticamente y seleccionamos los datos que son de nuestro interés.

```{r, warning = FALSE, message = FALSE}
registroNuevasInfecciones <- rename(.data = registro_nuevas_infecciones_por_vih, Provincia = "Provincia residencia", Codigo_Riesgo = "Código Grupo de riesgo asignado", Grupo_Riesgo = "grupo riesgo", Año = "VIH")%>%
  relocate(., "País de nacimiento (si no es España)", .before = "Estado clínico de la infección por VIH")%>%
  select(., Provincia:Grupo_Riesgo)

registroRegionalSida <- rename(.data = registro_regional_de_sida, Año = "Año de diagnóstico", Edad = "Edad años", Codigo_Riesgo = "Código Grupo de riesgo", Grupo_Riesgo = "Grupo de riesgo", Provincia = "provincia")%>%
  relocate(., "Edad meses", .after = Grupo_Riesgo)%>%
  relocate(.,"País de origen", .after = Grupo_Riesgo)%>%
  dplyr::filter(Año < 2009)%>%
  select(., Año:Grupo_Riesgo)%>%
  mutate(Provincia = factor(Provincia, levels = c("Burgos", "León", "Ávila", "Zamora", "Salamanca", "Segovia", "Valladolid", "Palencia", "Soria"), labels = c("BURGOS", "LEON", "AVILA", "ZAMORA", "SALAMANCA", "SEGOVIA", "VALLADOLID", "PALENCIA", "SORIA")))

poblacion <- rename(.data = poblacionCyL, Provincia = "Provincias", Edad = "Edad (3 grupos de edad)")%>%
 mutate(Provincia = factor(Provincia, levels = c("09 Burgos", "24 León", "05 Ávila", "49 Zamora", "37 Salamanca", "40 Segovia", "47 Valladolid", "34 Palencia", "42 Soria"), labels = c("BURGOS", "LEON", "AVILA", "ZAMORA", "SALAMANCA", "SEGOVIA", "VALLADOLID", "PALENCIA", "SORIA")))%>%
  dplyr::filter(., Sexo != "Ambos sexos", Edad != "TOTAL EDADES", Provincia %in% c("09 Burgos", "24 León", "05 Ávila", "49 Zamora", "37 Salamanca", "40 Segovia", "47 Valladolid", "34 Palencia", "42 Soria"))%>%
  select(., Provincia, Sexo, Edad, Año, Total)#%>%

```

Antes pasar a unir las tablas tenemos que saber si es posible. Para ello obtendremos los niveles de las variables cuantificables de ambas. Observando los resultados, podemos ver que los niveles de variables de interés de ambas tablas coinciden, por lo que podemos continuar.

```{r, warning = FALSE, message = FALSE}
levels(factor(registroRegionalSida$Sexo))
levels(factor(registroRegionalSida$Provincia))
levels(factor(registroRegionalSida$Grupo_Riesgo))

levels(factor(registroNuevasInfecciones$Sexo))
levels(factor(registroNuevasInfecciones$Provincia))
levels(factor(registroNuevasInfecciones$Grupo_Riesgo))
```

```{r}

promedioAntiguos <- registroRegionalSida%>%
  group_by(Grupo_Riesgo, Sexo)%>%
  dplyr::filter(n() > 1)%>%
  summarise(across(c(Año), ~ trunc(mean(.x, na.rm = TRUE))))%>%
  arrange(Año)

promedioAntiguos

promedioNuevos <- registroNuevasInfecciones%>%
  group_by(Grupo_Riesgo, Sexo)%>%
  dplyr::filter(n() > 1)%>%
  summarise(across(c(Año), ~ trunc(mean(.x, na.rm = TRUE))))%>%
  arrange(Año)

promedioNuevos 

unionpromedios <- full_join(x = promedioAntiguos, y = promedioNuevos)

unionpromedios

```
```{r}
ggplot(data = unionpromedios, aes(x = Sexo, y = Año, group = Grupo_Riesgo, color = Grupo_Riesgo))+
 geom_line()

ggplot(data = promedioNuevos, aes(x = Sexo, y = Año, group = Grupo_Riesgo, color = Grupo_Riesgo))+
 geom_line()
```
